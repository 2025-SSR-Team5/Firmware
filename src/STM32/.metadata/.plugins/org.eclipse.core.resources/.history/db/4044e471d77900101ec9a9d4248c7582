/*
 * initial_operation.c
 *
 *  Created on: Aug 15, 2025
 *      Author: takeu
 */


#include "main.h"
extern I2C_HandleTypeDef hi2c1;

#define CHECK_MAX_DELAY 5000 // 5 seconds

HAL_StatusTypeDef Check_I2C_to_ESP32(uint8_t devstat){
	uint8_t message[10];
	HAL_StatusTypeDef i2cstat;
	if((i2cstat = HAL_I2C_Slave_Receive(&hi2c1, buf, sizeof(buf), CHECK_MAX_DELAY)) == HAL_OK){
		if(strcmp(message,"Check_STM")){

		}else{
			HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_6);
			return HAL_ERROR;
		}
	}else{
		HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_6);
		return i2cstat;
	}
	uint16_t dev_id = DBGMCU->IDCODE & 0x0FFF;
	uint16_t rev_id = (DBGMCU->IDCODE >> 16);

	uint8_t buf[5];

	buf[0] = devstatus;
	if (status == 0) {
		buf[1] = dev_id & 0xFF;
		buf[2] = dev_id >> 8;
		buf[3] = rev_id & 0xFF;
		buf[4] = rev_id >> 8;
	}else{
		for(int i=1;i < sizeof(buf);i++) buf[i] = '';
	}

	return HAL_I2C_Slave_Transmit(&hi2c1, buf, sizeof(buf), CHECK_MAX_DELAY);
}
