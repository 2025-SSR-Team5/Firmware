/*
 * initial_operation.c
 *
 *  Created on: Aug 15, 2025
 *      Author: takeu
 */


#include "main.h"
#include "stm32c0xx.h"
#include "string.h"
extern I2C_HandleTypeDef hi2c1;


HAL_StatusTypeDef Check_I2C_to_ESP32(uint8_t devstat){
	uint8_t message[10];
	HAL_StatusTypeDef i2cstat;
	if((i2cstat = HAL_I2C_Slave_Receive(&hi2c1, message, sizeof(message), CHECK_MAX_DELAY)) == HAL_OK){
		if(strcmp((char*)message,"Check_STM") == 0){

		}else{
			HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_11);
			return HAL_ERROR;
		}
	}else{
		HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_12);
		return i2cstat;
	}

	uint32_t id_data[4];

	id_data[0] = HAL_GetDEVID();
	id_data[1] = HAL_GetUIDw0();
	id_data[2] = HAL_GetUIDw1();
	id_data[3] = HAL_GetUIDw2();

	uint8_t buf[17];

	buf[0] = devstat;
	if (devstat == 0) {
		for(int i=0; i < 4; i++){
			buf[1 + 4*i] = id_data[i + 1] & 0xFF;
			buf[2 + 4*i] = id_data[i + 1] >> 8;
			buf[3 + 4*i] = id_data[i + 1] >> 16;
			buf[4 + 4*i] = id_data[i + 1] >> 24;
		}
	}else{
		for(int i=1;i < sizeof(buf);i++) buf[i] = '\0';
	}

	return HAL_I2C_Slave_Transmit(&hi2c1, buf, sizeof(buf), CHECK_MAX_DELAY);
}
