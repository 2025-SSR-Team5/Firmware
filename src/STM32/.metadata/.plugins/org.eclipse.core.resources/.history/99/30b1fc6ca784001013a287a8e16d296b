/*
 * connection.c
 *
 *  Created on: Aug 15, 2025
 *      Author: takeu
 */

#include "initial_operation.h"
#include "connection.h"
#include "stepper.h"

#define STEP_PER_REV 2048

extern I2C_HandleTypeDef hi2c1;

HAL_StatusTypeDef do_instruction(uint8_t devstat){
	uint8_t instruction;
	HAL_StatusTypeDef result = HAL_ERROR;

	if(HAL_I2C_Slave_Receive(&hi2c1,&instruction, 1, HAL_MAX_DELAY) == HAL_OK){
		HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_8);
		switch (instruction){
		case 0x00 :
			result = Check_I2C_to_ESP32(devstat);
			break;
		case 0x01 :
			HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_11);
			move_clockwise(STEP_PER_REV,10);
			HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_11);
			break;
		case 0x02 :
			HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_12);
			move_anticlockwise(STEP_PER_REV,10);
			HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_12);
			break;
		default:
			break;
		}
	}

	return result;
}
