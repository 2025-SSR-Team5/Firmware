/*
 * initial_operation.c
 *
 *  Created on: Aug 15, 2025
 *      Author: takeu
 */


#include "main.h"
#include "stm32c0xx.h"
#include "string.h"
extern I2C_HandleTypeDef hi2c1;

#define CHECK_MAX_DELAY 5000 // 5 seconds

HAL_StatusTypeDef Check_I2C_to_ESP32(uint8_t devstat){
	uint8_t message[10];
	HAL_StatusTypeDef i2cstat;
	if((i2cstat = HAL_I2C_Slave_Receive(&hi2c1, message, sizeof(message), CHECK_MAX_DELAY)) == HAL_OK){
		if(strcmp((char*)message,"Check_STM") == 0){

		}else{
			HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_6);
			return HAL_ERROR;
		}
	}else{
		HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_6);
		return i2cstat;
	}

	uint32_t id_data[4];

	id_data[0] = HAL_GetDEVID();
	id_data[1] = HAL_GetUIDw0();
	id_data[2] = HAL_GetUIDw1();
	id_data[3] = HAL_GetUIDw1();

	uint8_t buf[17];

	buf[0] = devstat;
	if (devstat == 0) {
		for(int j=0; j < 4; j++)
			for(int i=1; i <= 4; i++){
				buf[1 + 4*j] = id_data[j] & 0xFF;
				buf[2 + 4*j] = id_data[j] >> 8;
				buf[3 + 4*j] = id_data[j] >> 16;
				buf[4 + 4*j] = id_data[j] >> 24;
			}
	}else{
		for(int i=1;i < sizeof(buf);i++) buf[i] = '';
	}

	return HAL_I2C_Slave_Transmit(&hi2c1, buf, sizeof(buf), CHECK_MAX_DELAY);
}
